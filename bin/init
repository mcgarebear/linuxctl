#!/usr/bin/env bash

set -o errexit
set -o nounset
set -o pipefail

# help writes usage information to the console.
help () {
  local -r executable=${1}
  cat << EOF
${executable} [flag..]

SYNOPSIS:
  init intitializes the system by configuring the home directory, shell, and
  prompt for the system.

FLAGS:
  -h, --help
    Display usage and exit.

OPTIONS:
  --config
    Path to the config directory. Defaults to \`../config\`.
  --home
    Path to the home directory. Defaults to \`\${HOME}\`.
  --shell
    Path to shell. Defaults to \`\${SHELL}\`.

ENVIRONMENT:
  \${HOME}=${HOME}
  \${SHELL}=${SHELL}
EOF
}

# main is the entry point of the script. It returns zero upon successful
# execution. If an error was encountered during execution, it returns non-zero.
main () {
  local -r __file_path=$(realpath $0)
  local -r __file_name=$(basename "${__file_path}")
  local -r __file_dir=$(dirname "${__file_path}")

  local home="${HOME}"
  local shell="${SHELL}"
  local config_dir=$(realpath "${__file_dir}/../config")

  while test $# -gt 0; do
    case "$1" in
      -h | --help)
        help "${__file_name}"
        return 0
        ;;
      --config)
        config="${2}"
        shift 2
        ;;
      --home)
        home="${2}"
        shift 2
        ;;
      --shell)
        shell="${2}"
        shift 2
        ;;
      *)
        break
        ;;
    esac
  done

  shopt -s autocd
  shopt -s cdspell
  shopt -s checkwinsize
  shopt -s direxpand
  shopt -s dirspell
  shopt -s extglob
  shopt -s failglob
  shopt -s globstar
  shopt -s histappend
  shopt -s histreedit
  shopt -s histverify

  [[ -d "${home}" ]] || mkdir -p "${home}"
  [[ -d "${home}/.config" ]] || mkdir -p "${home}/.config"
  [[ -d "${home}/.config/linuxctl" ]] || mkdir -p "${home}/.config/linuxctl"
  [[ -d "${home}/bin" ]] || mkdir -p "${home}/bin"
  [[ -d "${home}/code" ]] || mkdir -p "${home}/code"

  [[ -f "${home}/.inputrc" ]] \
    || cp --archive "${config_dir}/home/.inputrc" "${home}"

  export PATH="${HOME}/bin:${PATH}"

  [[ -f "${config_dir}/home/.prompt" ]] && source "${config_dir}/home/.prompt"

  /usr/bin/env "${shell}"

  return 0
}

main $@
